---
title: "Permutation Test for maximum effects"
author: "Jordi Cort√©s"
date: "30/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Aim

The aim of this document is to explain a simulation to test the confidence interval for the Maximum individual effect in a randomized controlled trial.

The way to estimate the confifence interval is in this [paper](https://pdfs.semanticscholar.org/ab4f/a0ba353ce8b3745c3846222f1c0c4501a8c6.pdf?_ga=2.81402007.12395602.1580406400-1104814477.1580406400)

There is a more recent version in [*ArXiv*](https://arxiv.org/pdf/1709.07339.pdf): 

### Parameters

- __*NSIM*__: number of simulations
- __*nsim*__: number of permutation tests
- __*n*__: sample size
- __*minE*__: minimum effect
- __*maxE*__: maximum effect  
- __*$T_h$*__: candidate effects to test

```{r}
NSIM <- 1000   # Number of simulations
nsim <- 500    # number of permutation tests
n <- 200       # sample size
minE <- 0      # minimum effect
maxE <- 10     # maximum effect  
Th <- 0:100    # candidate effects to test
```


## Complete code

The complete code does not run to generate this document because of the execution time (1 hour). 

```{r eval=FALSE}
rm(list=ls())
set.seed(12345)
NSIM <- 1000   # Number of simulations
nsim <- 500    # number of permutation tests
n <- 200       # sample size
minE <- 0      # minimum effect
maxE <- 10     # maximum effect  
Th <- 0:100    # 70 # (maxE+1)
LS <- c()
fn <- function(x,d=2) formatC(x,digits=d,format='f')
for (sim in 1:NSIM){
  
  ##-- Generate potential outcomes -------------------------
  Y1 <- round(rnorm(n,100,10))            # Control group
  effect <- sample(minE:maxE,n,rep=TRUE)  # Effect
  Y2 <- Y1 + effect                       # Treated group  

  ##-- Allocation
  treated <- sample(c(FALSE,TRUE),n,rep=TRUE)
  y1 <- Y1[treated]               # Treated
  y2 <- Y2[!treated]              # Control 
  d <- data.frame(y=c(y1,y2),x=c(rep(0,length(y1)),rep(1,length(y2))))
  
  ##-- Observed statistic
  t_obs <- with(d,diff(tapply(y,x,mean)))
  
  
  ##-- Permutations
  j <- 1     # counter
  p <- 0     # pvalue of the permutation test
  th <- 0    # first treatment effect tested
  while(th<max(Th) & p<0.05){  # If the permutation test is not significanfe, we test constant treatment effects between 0 and Th
    cat('=')
    th <- Th[j]          
    y1_imp <- c(y2 - th, y1)         # Imputed values for control group
    y2_imp <- c(y2,      y1 + th)    # Imputed values for treated group
    sta <- c()
    w <- sample(0:1,length(y1_imp),rep=TRUE) # allocate treatment at random
    y_imp <- ifelse(w,y1_imp,y2_imp)         # Observed values
    
    # nsim permutations
    for (k in 1:nsim){
      daux <- data.frame(y=y_imp,x=sample(0:1,length(y1_imp),rep=TRUE)) # auxiliar data.frame   
      sta[k] <- with(daux,diff(tapply(y,x,mean)))                      # all statistics at random
    }
    p <- sum(sta>t_obs)/nsim  # pvalue
    j <- j+1                  # increase counter
  }
  
  ## Print the results during simulation
  cat('\n')
  LS[sim] <- th
  bn <- binom.test(sum(LS<maxE),length(LS))
  cat('sim:',sim,'LS:',LS[sim],'t_obs:',fn(t_obs,d=2),
      'p:',fn(p,3),'confidence:',
      paste0(fn(bn$estimate,3),' [',fn(bn$con[1],3),',',fn(bn$con[2],3),']'),'\n')
}

```

## Results

Instead, we recover all the upper limits for the confidence intervals of the **Maximum individual effect**

The real Maximum Individual Effect ($\theta$) is `r maxE`. The distribution of the upper limit for this parameter is shown in the next histogram.

```{r warning=FALSE}
library(ggplot2)
d <- read.table('C:/Users/jcortes/Google Drive/Tesis/Memoria/Scripts/LS_Confidence_intervals.txt',header = FALSE)
ggplot(d,aes(x=V1)) + geom_histogram() + geom_vline(xintercept = maxE, color='red') + xlab(expression (hat(theta)))
summary(d[,1])
```

The proportion of intervals that contains the real value is `r round(sum(d[,1]>=maxE)/nrow(d),3)` (`r sum(d[,1]>=maxE)`/`r nrow(d)`)


## Conclusions

It is true that is a method that works because *`r round(sum(d[,1]>=maxE)/nrow(d),3)`* is very colose to 1-$\alpha=0.95$ but the distribution of $\hat{\theta}$ is far away of the real value ($\theta=$maxE): the mean is 3 fold the real value.